<div class="container-fluid p-4">
  <div class="row">
    <div class="col-12">
      <!-- Page Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h4 class="text-dark mb-1">
            <i class="mdi mdi-home-city text-success me-2"></i>
            {{ isEditMode ? 'Edit Estate' : 'Add New Estate' }}
          </h4>
          <p class="text-muted mb-0">
            {{ isEditMode ? 'Update estate information and settings' : 'Create a new estate for electricity distribution' }}
          </p>
        </div>
        <button type="button" class="btn btn-outline-secondary" (click)="onCancel()">
          <i class="mdi mdi-arrow-left me-1"></i>
          Back to Estates
        </button>
      </div>

      <!-- Loading State -->
      <div *ngIf="loading" class="text-center py-5">
        <div class="spinner-border text-success" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading estate details...</p>
      </div>

      <!-- Error Alert -->
      <div *ngIf="error" class="alert alert-danger" role="alert">
        <i class="mdi mdi-alert-circle me-2"></i>
        {{ error }}
      </div>

      <!-- Estate Form -->
      <div class="card border-0 shadow-sm" *ngIf="!loading">
        <div class="card-body p-4">
          <form [formGroup]="estateForm" (ngSubmit)="onSubmit()">

            <!-- Basic Information -->
            <div class="row mb-4">
              <div class="col-12">
                <h5 class="text-dark mb-3">
                  <i class="mdi mdi-information-outline text-primary me-2"></i>
                  Basic Information
                </h5>
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Estate Name *</label>
                <input
                  type="text"
                  class="form-control"
                  formControlName="name"
                  placeholder="Enter estate name"
                  maxlength="100"
                  [class.is-invalid]="getFieldError('name')"
                >
                <div class="invalid-feedback">{{ getFieldError('name') }}</div>
                <small class="form-text text-muted">Maximum 100 characters</small>
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Estate Type *</label>
                <select class="form-select" formControlName="type">
                  <option *ngFor="let type of estateTypes" [value]="type">{{ type }}</option>
                </select>
              </div>

              <div class="col-12 mb-3">
                <label class="form-label fw-semibold">Description</label>
                <textarea
                  class="form-control"
                  formControlName="description"
                  rows="3"
                  placeholder="Enter estate description"
                  maxlength="500"
                  [class.is-invalid]="getFieldError('description')"
                ></textarea>
                <div class="invalid-feedback">{{ getFieldError('description') }}</div>
                <small class="form-text text-muted">Maximum 500 characters</small>
              </div>
            </div>

            <!-- Address Information -->
            <div class="row mb-4" formGroupName="address">
              <div class="col-12">
                <h5 class="text-dark mb-3">
                  <i class="mdi mdi-map-marker-outline text-info me-2"></i>
                  Address Information
                </h5>
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Street Address *</label>
                <input
                  type="text"
                  class="form-control"
                  formControlName="street"
                  placeholder="Enter street address"
                  [class.is-invalid]="getNestedFieldError('address', 'street')"
                >
                <div class="invalid-feedback">{{ getNestedFieldError('address', 'street') }}</div>
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Suburb</label>
                <input
                  type="text"
                  class="form-control"
                  formControlName="suburb"
                  placeholder="Enter suburb"
                >
              </div>

              <div class="col-md-4 mb-3">
                <label class="form-label fw-semibold">City *</label>
                <input
                  type="text"
                  class="form-control"
                  formControlName="city"
                  placeholder="Enter city"
                  [class.is-invalid]="getNestedFieldError('address', 'city')"
                >
                <div class="invalid-feedback">{{ getNestedFieldError('address', 'city') }}</div>
              </div>

              <div class="col-md-4 mb-3">
                <label class="form-label fw-semibold">Province *</label>
                <select
                  class="form-select"
                  formControlName="province"
                  [class.is-invalid]="getNestedFieldError('address', 'province')"
                >
                  <option value="">Select province</option>
                  <option value="Gauteng">Gauteng</option>
                  <option value="Western Cape">Western Cape</option>
                  <option value="KwaZulu-Natal">KwaZulu-Natal</option>
                  <option value="Eastern Cape">Eastern Cape</option>
                  <option value="Free State">Free State</option>
                  <option value="Limpopo">Limpopo</option>
                  <option value="Mpumalanga">Mpumalanga</option>
                  <option value="North West">North West</option>
                  <option value="Northern Cape">Northern Cape</option>
                </select>
                <div class="invalid-feedback">{{ getNestedFieldError('address', 'province') }}</div>
              </div>

              <div class="col-md-4 mb-3">
                <label class="form-label fw-semibold">Postal Code *</label>
                <input
                  type="text"
                  class="form-control"
                  formControlName="postalCode"
                  placeholder="e.g. 2000"
                  maxlength="4"
                  pattern="[0-9]{4}"
                  title="Please enter exactly 4 digits"
                  [class.is-invalid]="getNestedFieldError('address', 'postalCode')"
                >
                <div class="invalid-feedback">{{ getNestedFieldError('address', 'postalCode') }}</div>
                <small class="form-text text-muted">Enter exactly 4 digits</small>
              </div>
            </div>

            <!-- Coordinates (Optional) -->
            <div class="row mb-4" formGroupName="coordinates">
              <div class="col-12">
                <h5 class="text-dark mb-3">
                  <i class="mdi mdi-crosshairs-gps text-warning me-2"></i>
                  GPS Coordinates (Optional)
                </h5>
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Latitude</label>
                <input
                  type="number"
                  step="any"
                  class="form-control"
                  formControlName="latitude"
                  placeholder="e.g., -26.2041"
                >
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Longitude</label>
                <input
                  type="number"
                  step="any"
                  class="form-control"
                  formControlName="longitude"
                  placeholder="e.g., 28.0473"
                >
              </div>
            </div>

            <!-- Tariff Information -->
            <div class="row mb-4" formGroupName="tariff">
              <div class="col-12">
                <h5 class="text-dark mb-3">
                  <i class="mdi mdi-currency-usd text-success me-2"></i>
                  Electricity Tariff
                </h5>
              </div>

              <div class="col-md-4 mb-3">
                <label class="form-label fw-semibold">Rate *</label>
                <input
                  type="number"
                  step="0.01"
                  min="0"
                  class="form-control"
                  formControlName="rate"
                  placeholder="e.g., 2.50"
                  [class.is-invalid]="getNestedFieldError('tariff', 'rate')"
                >
                <div class="invalid-feedback">{{ getNestedFieldError('tariff', 'rate') }}</div>
              </div>

              <div class="col-md-4 mb-3">
                <label class="form-label fw-semibold">Currency *</label>
                <select class="form-select" formControlName="currency">
                  <option value="ZAR">ZAR (South African Rand)</option>
                  <option value="USD">USD (US Dollar)</option>
                  <option value="EUR">EUR (Euro)</option>
                </select>
              </div>

              <div class="col-md-4 mb-3">
                <label class="form-label fw-semibold">Unit *</label>
                <select class="form-select" formControlName="unit">
                  <option value="kWh">kWh (Kilowatt Hours)</option>
                  <option value="MWh">MWh (Megawatt Hours)</option>
                </select>
              </div>
            </div>

            <!-- Amenities -->
            <div class="row mb-4">
              <div class="col-12">
                <h5 class="text-dark mb-3">
                  <i class="mdi mdi-home-variant-outline text-info me-2"></i>
                  Amenities
                </h5>
                <p class="text-muted mb-3">Select the amenities available at this estate</p>

                <div class="row">
                  <div class="col-md-3 col-sm-6 mb-2" *ngFor="let amenity of availableAmenities">
                    <div class="form-check">
                      <input
                        type="checkbox"
                        class="form-check-input"
                        [id]="'amenity-' + amenity"
                        [checked]="isAmenitySelected(amenity)"
                        (change)="onAmenityToggle(amenity)"
                      >
                      <label class="form-check-label" [for]="'amenity-' + amenity">
                        {{ amenity }}
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Status (Edit Mode Only) -->
            <div class="row mb-4" *ngIf="isEditMode">
              <div class="col-12">
                <h5 class="text-dark mb-3">
                  <i class="mdi mdi-toggle-switch-outline text-warning me-2"></i>
                  Status
                </h5>
              </div>

              <div class="col-md-6">
                <div class="form-check form-switch">
                  <input
                    type="checkbox"
                    class="form-check-input"
                    id="isActive"
                    formControlName="isActive"
                  >
                  <label class="form-check-label" for="isActive">
                    Estate is Active
                  </label>
                  <small class="form-text text-muted d-block">
                    Inactive estates will not be available for new tenants
                  </small>
                </div>
              </div>
            </div>

            <!-- Form Actions -->
            <div class="row">
              <div class="col-12">
                <hr class="my-4">
                <div class="d-flex gap-3">
                  <button
                    type="submit"
                    class="btn btn-success px-4"
                    [disabled]="saving || estateForm.invalid"
                  >
                    <span *ngIf="saving" class="spinner-border spinner-border-sm me-2"></span>
                    <i *ngIf="!saving" class="mdi mdi-content-save me-2"></i>
                    {{ saving ? 'Saving...' : (isEditMode ? 'Update Estate' : 'Create Estate') }}
                  </button>

                  <button
                    type="button"
                    class="btn btn-outline-secondary px-4"
                    (click)="onCancel()"
                    [disabled]="saving"
                  >
                    <i class="mdi mdi-close me-2"></i>
                    Cancel
                  </button>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
